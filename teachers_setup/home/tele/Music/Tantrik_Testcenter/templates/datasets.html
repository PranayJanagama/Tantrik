<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Datasets Management</title>
    <link rel="stylesheet" href="/static/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/css/fontawesome-6.6.0/css/all.min.css">
    <script src="/static/js/jquery-3.6.0.min.js"></script>
    <script src="/static/js/bootstrap.bundle.min.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f6f9;
            padding: 20px;
            color: #0a0303;
        }

        h1,
        h2 {
            color: #333;
            text-align: center;
            margin-bottom: 20px;
        }

        .container {
            max-width: 900px;
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .btn-primary {
            background-color: #007bff;
            border: none;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            display: none;
            margin: 20px auto;
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }

        .tree-container ul {
            list-style-type: none;
            padding-left: 20px;
        }

        .tree-container li {
            position: relative;
            padding-left: 20px;
            cursor: pointer;
        }

        .tree-container li::before {
            content: 'üìÅ';
            position: absolute;
            left: 0;
            top: 0;
        }

        .tree-container .file::before {
            content: 'üìÑ';
        }

        .popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #007bff;
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 1000;
        }

        .alert-info {
            background-color: #e7f3fe;
            border-color: #b3d8fd;
            color: #31708f;
        }

        label {
            font-weight: bold;
        }

        input[type="file" i] {
            appearance: none;
            cursor: default;
            align-items: baseline;
            text-overflow: inherit;
            text-align: start !important;
            white-space: pre;
            padding-top: 5px;
            width: 90%;
            height: 90%;
        }
    </style>
</head>

<body>

    <h1><i class="fas fa-database"></i> Dataset Management</h1>

    <div class="container">
        <h2><i class="fas fa-upload"></i> Upload Datasets</h2>
        <form id="upload-form" action="/uploaddataset" method="post" enctype="multipart/form-data">
            <div class="mb-3">
                <label for="courses-dropdown">Course Name:</label>
                <select id="courses-dropdown" name="course_name" class="form-control" required>
                    <option value="" disabled selected>Select a course</option>
                    <!-- Dynamically populated -->
                </select>
            </div>
            <div class="mb-3">
                <label for="datasets">Dataset Files:</label>
                <input type="file" id="datasets" name="datasets" class="form-control" accept=".zip,.rar" required>
            </div>
            <button type="submit" class="btn btn-primary w-100"><i class="fas fa-paper-plane"></i> Submit</button>
        </form>
        <div class="loader" id="loader"></div>
    </div>

    <div class="container alert alert-info" style="display: block; text-align: center;">
        <strong>Note:</strong> Uploaded datasets can be accessed at:
        <code>/srv/shareddata/datasets/{coursename}/{filename}</code><br>
        <strong style="color: rgb(241, 40, 40);"> Click on Icons to copy path</strong>
    </div>

    <div class="container">
        <h2><i class="fas fa-folder-open"></i> Existing Datasets</h2>
        <div class="tree-container" id="tree-container">
            <!-- Dataset tree will be rendered here -->
        </div>
        <div class="file-content mt-3" id="file-content">
            <!-- File content will be displayed here -->
        </div>
    </div>

    <div class="popup" id="popup-message"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var user = '{{ user|safe }}';
            var token = '{{ token|safe }}';

            // Store values in sessionStorage
            if (user && token) {
                sessionStorage.setItem('user', user);
                sessionStorage.setItem('token', token);
            } else {
                console.error("User or Token is missing.");
            }
            const form = document.getElementById('upload-form');
            form.reset();
            const coursesDropdown = document.getElementById('courses-dropdown');
            coursesDropdown.innerHTML = '<option value="" disabled selected>Select a course</option>';
            document.getElementById('datasets').value = ''

            var user = sessionStorage.getItem('user');
            const fetchData = async () => {
                try {
                    const response = await fetch(`/datasets?user=${user}`);
                    const responseData = await response.json();
                    const coursesDropdown = document.getElementById('courses-dropdown');
                    responseData.courses.forEach(course => {
                        const option = document.createElement('option');
                        option.value = course;
                        option.textContent = course;
                        coursesDropdown.appendChild(option);
                    });
                    renderTree(responseData.files, '/srv/shareddata/datasets');
                } catch (error) {
                    console.error('Error fetching directory structure:', error.message);
                }
            };

            const renderTree = (data, basePath) => {
                const treeContainer = document.getElementById('tree-container');
                treeContainer.innerHTML = '';
                const ul = document.createElement('ul');
                treeContainer.appendChild(ul);
                createTreeNodes(data, ul, basePath);
            };

            const createTreeNodes = (node, parentElement, path) => {
                for (const [key, value] of Object.entries(node)) {
                    const li = document.createElement('li');
                    let newPath = `${path}/${key}`;
                    if (value !== null && typeof value === 'object') {
                        li.className = 'folder collapsed';
                        li.textContent = key;

                        // Add "Copy Path" button for folders
                        const tooltipContainer = document.createElement('div');
                        tooltipContainer.className = 'tooltip';
                        const copyButton = document.createElement('button');
                        copyButton.className = 'copy-button';
                        copyButton.innerHTML = '<i class="fa fa-copy"></i>';
                        copyButton.onclick = () => copyToClipboard(newPath);
                        tooltipContainer.appendChild(copyButton);
                        li.appendChild(tooltipContainer);
                        
                        const ul = document.createElement('ul');
                        li.appendChild(ul);
                        createTreeNodes(value, ul, newPath);
                    } else {
                        li.className = 'file';
                        const fileNameSpan = document.createElement('span');
                        fileNameSpan.textContent = key;
                        li.appendChild(fileNameSpan);

                        const tooltipContainer = document.createElement('div');
                        tooltipContainer.className = 'tooltip';
                        const copyButton = document.createElement('button');
                        copyButton.className = 'copy-button';
                        copyButton.innerHTML = '<i class="fa fa-copy"></i>';
                        copyButton.onclick = () => copyToClipboard(newPath);
                        tooltipContainer.appendChild(copyButton);
                        li.appendChild(tooltipContainer);
                    }
                    parentElement.appendChild(li);
                }
            };

            document.getElementById('tree-container').addEventListener('click', function (e) {
                const target = e.target;
                if (target.tagName === 'LI' && target.classList.contains('folder')) {
                    target.classList.toggle('expanded');
                    target.classList.toggle('collapsed');
                }
            });

            // Handle form submission with loader and popup
            document.getElementById('upload-form').addEventListener('submit', async function (e) {
                e.preventDefault();
                const form = e.target;
                const formData = new FormData(form);
                const loader = document.getElementById('loader');
                const popupMessage = document.getElementById('popup-message');

                loader.style.display = 'block';

                try {
                    const response = await fetch(form.action, {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    popupMessage.textContent = result.message;
                    popupMessage.style.display = 'block';

                    setTimeout(() => {
                        popupMessage.style.display = 'none';
                        window.location.href = result.redirect_url;
                        form.reset();

                        // Reset the course dropdown
                        const coursesDropdown = document.getElementById('courses-dropdown');
                        coursesDropdown.innerHTML = '<option value="" disabled selected>Select a course</option>';

                        // Clear the file input (in case it's not reset by form.reset())
                        document.getElementById('datasets').value = '';

                        // Fetch data to update the tree view
                        fetchData();
                    }, 2000);

                } catch (error) {
                    console.error('Error uploading dataset:', error.message);
                } finally {
                    loader.style.display = 'none';
                }
            });

            const copyToClipboard = (text) => {
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(text).then(() => {
                        alert('Text copied to clipboard!');
                    }).catch(err => {
                        alert('Failed to copy text: ' + err);
                        console.error('Failed to copy text: ', err);
                    });
                } else {
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    document.body.appendChild(textArea);
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        alert('path copied to clipboard');
                    } catch (err) {
                        alert('Failed to copy text: ' + err);
                        console.error('Failed to copy text: ', err);
                    }
                    document.body.removeChild(textArea);
                }
            };
            fetchData();
        });
    </script>
</body>

</html>